<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mental Lab v1.1</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #161b22; color: #e5e7eb; display: flex; flex-direction: column; height: 100vh; font-size: 1.2rem; overflow: hidden; }
    
    /* 상단 네비 */
    .nav { display: flex; gap: 15px; padding: 15px; background: #0f141a; border-bottom: 1px solid #2f3540; flex: 0 0 auto; align-items: center; }
    .nav button { padding: 8px 16px; border-radius: 8px; border: 1px solid #2f3540; background: #1f252f; color: #e5e7eb; cursor: pointer; font-size: 1.1rem; font-weight: 600; }
    .nav button.active { background: #e5e7eb; color: #0f141a; }
    #toggleSidebar { background: #238636; border: none; color: white; margin-left: auto; }

    .main-container { display: flex; flex: 1; position: relative; overflow: hidden; width: 100%; }

    /* 사이드바 */
    .formula-sidebar { width: 320px; background: #0d1117; border-right: 1px solid #2f3540; padding: 20px; overflow-y: auto; transition: transform 0.3s ease; z-index: 100; flex-shrink: 0; }
    @media (max-width: 768px) { .formula-sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); } .formula-sidebar.open { transform: translateX(0); } }
    .formula-item { background: #161b22; padding: 12px 15px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; color: #58a6ff; border: 1px solid #30363d; font-size: 1.1rem; line-height: 1.4; }

    /* 메인 콘텐츠 */
    .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; width: 100%; }

    /* 카드 디자인 */
    .card { width: 100%; max-width: 500px; background: #1f252f; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); margin-bottom: 20px; }
    .card h2 { margin: 0 0 15px; font-size: 1.6rem; text-align: center; color: #8b949e; }
    
    .row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; justify-content: center; }
    .row label { font-size: 0.9rem; display: flex; flex-direction: column; gap: 5px; color: #9ca3af; }
    .row input { padding: 10px; border-radius: 8px; border: 1px solid #2f3540; background: #161b22; color: #e5e7eb; width: 90px; font-size: 1.1rem; text-align: center; }
    
    .problem { font-size: 3.5rem; font-weight: 800; text-align: center; margin: 30px 0 15px; min-height: 1.2em; color: #ffffff; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
    .timer { font-size: 1.2rem; text-align: center; color: #6b7280; margin-bottom: 20px; font-family: monospace; }
    
    .answer-row { display: flex; justify-content: center; width: 100%; margin-bottom: 15px; }
    .answer-row input { width: 100%; max-width: 300px; padding: 15px; border-radius: 12px; border: 2px solid #30363d; background: #0d1117; color: #e5e7eb; font-size: 2.2rem; text-align: center; outline: none; transition: border-color 0.2s; }
    .answer-row input:focus { border-color: #58a6ff; }

    .result { text-align: center; min-height: 1.8em; font-size: 1.4rem; font-weight: bold; margin-top: 10px; }
    .result.correct { color: #10b981; }
    .result.wrong { color: #ef4444; }

    /* 히스토리 & 그래프 */
    .history { width: 100%; max-width: 500px; background: #1f252f; border-radius: 15px 15px 0 0; padding: 20px; border-top: 1px solid #2f3540; height: 200px; overflow-y: auto; font-size: 1.1rem; }
    .graph { width: 100%; max-width: 500px; padding: 15px; background: #1f252f; border-radius: 0 0 15px 15px; border-top: 1px solid #2f3540; margin-bottom: 40px; }
    .graph-bars { display: flex; gap: 5px; align-items: flex-end; min-height: 35px; justify-content: center; }
    .bar { width: 12px; height: 30px; background: #4b5563; border-radius: 3px; }
  </style>
</head>
<body>

  <div class="nav">
    <button id="navMul" class="active">곱셈</button>
    <button id="navExp">지수</button>
    <button id="toggleSidebar">공식 보기</button>
  </div>

  <div class="main-container">
    <div class="formula-sidebar" id="sidebar">
      <div class="formula-group">
        <h3>Algebraic</h3>
        <div class="formula-item">(a+b)(a-b) <br>= a²-b²</div>
        <div class="formula-item">(a±b)² <br>= a²±2ab+b²</div>
        <div class="formula-item">(x+a)(x+b) <br>= x²+(a+b)x+ab</div>
      </div>
      <div class="formula-group">
        <h3>Power & Log</h3>
        <div class="formula-item">aᵐ · aⁿ <br>= aᵐ⁺ⁿ</div>
        <div class="formula-item">(aᵐ)ⁿ <br>= aᵐⁿ</div>
      </div>
    </div>

    <div class="content">
      <div id="mulCard" class="card">
        <h2>Multiplication</h2>
        <div class="row">
          <label>Digits L <input type="number" id="digitsA" value="2" /></label>
          <label>Digits R <input type="number" id="digitsB" value="2" /></label>
          <button id="mulNew" style="padding:10px 20px; border-radius:8px; cursor:pointer; background:#238636; color:white; border:none; font-weight:bold;">New</button>
        </div>
        <div class="problem" id="mulProblem">Start!</div>
        <div class="timer" id="mulTimer">0.00s</div>
        <div class="answer-row">
          <input type="text" id="mulAns" placeholder="?" autocomplete="off" />
        </div>
        <div class="result" id="mulResult"></div>
      </div>

      <div id="expCard" class="card" style="display:none;">
        <h2>Exponential</h2>
        <div class="row">
          <select id="expBase" style="padding:10px; border-radius:8px; background:#161b22; color:white; border:1px solid #2f3540;">
            <option value="2">2ⁿ</option>
            <option value="3">3ⁿ</option>
          </select>
          <label>min <input type="number" id="expNMin" value="1" /></label>
          <label>max <input type="number" id="expNMax" value="10" /></label>
          <button id="expNew" style="padding:10px 20px; border-radius:8px; cursor:pointer; background:#238636; color:white; border:none; font-weight:bold;">New</button>
        </div>
        <div class="problem" id="expProblem">Start!</div>
        <div class="timer" id="expTimer">0.00s</div>
        <div class="answer-row">
          <input type="text" id="expAns" placeholder="?" autocomplete="off" />
        </div>
        <div class="result" id="expResult"></div>
      </div>

      <div class="history" id="history"></div>
      <div class="graph"><div class="graph-bars" id="graphBars"></div></div>
    </div>
  </div>

  <script>
    // --- Elements ---
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleSidebar");
    const historyBox = document.getElementById("history");
    const graphBars = document.getElementById("graphBars");
    
    const mulNew = document.getElementById("mulNew"), 
          mulProblem = document.getElementById("mulProblem"), 
          mulAns = document.getElementById("mulAns"), 
          mulResult = document.getElementById("mulResult"), 
          mulTimer = document.getElementById("mulTimer");

    const expNew = document.getElementById("expNew"), 
          expProblem = document.getElementById("expProblem"), 
          expAns = document.getElementById("expAns"), 
          expResult = document.getElementById("expResult"), 
          expTimer = document.getElementById("expTimer");

    // --- State ---
    let mode = "mul";
    let timer = null;
    let start = 0;
    let current = null; // 현재 문제 데이터
    let recent = [];    // 히스토리

    // --- Initialization ---
    window.onload = () => {
      const saved = localStorage.getItem('mentalLabHistory');
      if (saved) {
        recent = JSON.parse(saved);
        recent.forEach(item => renderHistoryUI(item.text, item.ok));
        updateGraph();
      }
    };

    // --- UI Logic ---
    function renderHistoryUI(text, ok) {
      const div = document.createElement("div");
      div.style.color = ok ? "#10b981" : "#ef4444";
      div.style.padding = "3px 0";
      div.textContent = text;
      historyBox.appendChild(div);
      historyBox.scrollTop = historyBox.scrollHeight;
    }

    function saveAndRender(text, ok) {
      renderHistoryUI(text, ok);
      recent.push({ text, ok });
      if (recent.length > 30) recent.shift();
      localStorage.setItem('mentalLabHistory', JSON.stringify(recent));
      updateGraph();
    }

    function updateGraph() {
      graphBars.innerHTML = "";
      recent.forEach(item => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.background = item.ok ? "#10b981" : "#ef4444";
        graphBars.appendChild(bar);
      });
    }

    toggleBtn.onclick = (e) => { e.stopPropagation(); sidebar.classList.toggle("open"); };
    document.onclick = (e) => { if (!sidebar.contains(e.target)) sidebar.classList.remove("open"); };

    // --- Timer Logic ---
    function startTimer(el) {
      start = performance.now();
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        el.textContent = ((performance.now() - start) / 1000).toFixed(2) + "s";
      }, 60);
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    // --- Game Logic ---
    function randNDigits(d) {
      d = Math.max(1, d);
      const min = Math.pow(10, d - 1);
      const max = Math.pow(10, d) - 1;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function triggerNewProblem() {
      if (mode === "mul") mulNew.click();
      else expNew.click();
    }

    // 네비게이션
    navMul.onclick = () => {
      mode = "mul";
      navMul.classList.add("active");
      navExp.classList.remove("active");
      document.getElementById("mulCard").style.display = "";
      document.getElementById("expCard").style.display = "none";
      mulAns.focus();
    };

    navExp.onclick = () => {
      mode = "exp";
      navExp.classList.add("active");
      navMul.classList.remove("active");
      document.getElementById("mulCard").style.display = "none";
      document.getElementById("expCard").style.display = "";
      expAns.focus();
    };

    // 곱셈 문제 생성
    mulNew.onclick = () => {
      const da = parseInt(document.getElementById("digitsA").value) || 2;
      const db = parseInt(document.getElementById("digitsB").value) || 2;
      
      current = {
        type: "mul",
        a: randNDigits(da),
        b: randNDigits(db)
      };
      
      mulProblem.textContent = `${current.a} × ${current.b}`;
      mulResult.textContent = "";
      mulAns.value = "";
      stopTimer();
      startTimer(mulTimer);
      mulAns.focus();
    };

    // 지수 문제 생성
    expNew.onclick = () => {
      const min = parseInt(document.getElementById("expNMin").value) || 1;
      const max = parseInt(document.getElementById("expNMax").value) || 10;
      const n = Math.floor(Math.random() * (max - min + 1)) + min;
      const base = parseInt(document.getElementById("expBase").value);

      current = {
        type: "exp",
        base: base,
        n: n
      };

      expProblem.textContent = `${current.base}^${current.n}`;
      expResult.textContent = "";
      expAns.value = "";
      stopTimer();
      startTimer(expTimer);
      expAns.focus();
    };

    // 정답 확인 (핵심 로직 Fix)
    function checkAnswer() {
      if (!current) return;
      stopTimer();
      
      let ans, correct, text;
      const input = current.type === "mul" ? mulAns : expAns;
      
      // 쉼표 제거 후 숫자 변환
      ans = Number(input.value.replace(/,/g, ""));
      
      if (current.type === "mul") {
        correct = current.a * current.b;
        text = `[Mul] ${current.a}×${current.b}=${ans}`;
      } else {
        // [FIX] n -> current.n 으로 수정
        correct = Math.pow(current.base, current.n);
        text = `[Exp] ${current.base}^${current.n}=${ans}`;
      }

      const ok = (ans === correct);
      const resEl = current.type === "mul" ? mulResult : expResult;
      
      resEl.textContent = `정답: ${correct.toLocaleString()} ${ok ? '· OK' : '· WRONG'}`;
      resEl.className = "result " + (ok ? "correct" : "wrong");
      
      saveAndRender(text, ok);
    }

    // 이벤트 리스너
    mulAns.onkeydown = (e) => { if (e.key === "Enter") checkAnswer(); };
    expAns.onkeydown = (e) => { if (e.key === "Enter") checkAnswer(); };

    // 스페이스바 입력 시 새 문제 (Input 포커스 아닐 때만)
    document.onkeydown = (e) => {
      if ((e.code === "Space" || e.key === " ") && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        triggerNewProblem();
      }
    };
    
    // 입력창 끝에 스페이스 입력 시 새 문제 트리거 (모바일 대응)
    const handleInputSpace = (input) => {
      if (input.value.endsWith(" ")) {
        input.value = input.value.trim();
        triggerNewProblem();
      }
    };
    mulAns.oninput = () => handleInputSpace(mulAns);
    expAns.oninput = () => handleInputSpace(expAns);

  </script>
</body>
</html>
