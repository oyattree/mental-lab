<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mental lab</title>
  <style>
    /* (CSS 영역은 이전과 동일하되, 슬라이드 기능을 유지합니다) */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #161b22; color: #e5e7eb; display: flex; flex-direction: column; height: 100vh; font-size: 1.2rem; overflow: hidden; }
    .nav { display: flex; gap: 15px; padding: 15px; background: #0f141a; border-bottom: 1px solid #2f3540; flex: 0 0 auto; align-items: center; }
    .nav button { padding: 8px 16px; border-radius: 8px; border: 1px solid #2f3540; background: #1f252f; color: #e5e7eb; cursor: pointer; font-size: 1.1rem; font-weight: 600; }
    .nav button.active { background: #e5e7eb; color: #0f141a; }
    #toggleSidebar { background: #238636; border: none; color: white; margin-left: auto; }
    .main-container { display: flex; flex: 1; position: relative; overflow: hidden; }
    .formula-sidebar { width: 320px; background: #0d1117; border-right: 1px solid #2f3540; padding: 20px; overflow-y: auto; transition: transform 0.3s ease; z-index: 100; }
    @media (max-width: 768px) { .formula-sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.5); } .formula-sidebar.open { transform: translateX(0); } }
    .formula-item { background: #161b22; padding: 12px 15px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; color: #58a6ff; border: 1px solid #30363d; font-size: 1.1rem; }
    .content { flex: 1; overflow-y: auto; padding: 20px; width: 100%; }
    .card { max-width: 500px; margin: 0 auto 20px; background: #1f252f; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
    .card h2 { margin: 0 0 10px; font-size: 1.5rem; text-align: center; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: flex-end; justify-content: center; }
    .row label { font-size: 0.9rem; display: flex; flex-direction: column; gap: 5px; }
    .row input { padding: 8px; border-radius: 8px; border: 1px solid #2f3540; background: #161b22; color: #e5e7eb; width: 80px; font-size: 1.1rem; }
    .problem { font-size: 3rem; font-weight: 700; text-align: center; margin: 20px 0 10px; min-height: 1.5em; color: #ffffff; }
    .answer-row input { width: 100%; max-width: 240px; padding: 12px; border-radius: 10px; border: 1px solid #2f3540; background: #161b22; color: #e5e7eb; font-size: 2rem; text-align: center; }
    .result { text-align: center; min-height: 1.8em; font-size: 1.3rem; font-weight: bold; }
    .result.correct { color: #10b981; }
    .result.wrong { color: #ef4444; }
    .history { max-width: 500px; margin: 10px auto 0; background: #1f252f; border-radius: 15px 15px 0 0; padding: 15px; border-top: 1px solid #2f3540; height: 180px; overflow-y: auto; font-size: 1rem; }
    .graph { max-width: 500px; margin: 0 auto 10px; padding: 10px; background: #1f252f; border-radius: 0 0 15px 15px; border-top: 1px solid #2f3540; }
    .graph-bars { display: flex; gap: 4px; align-items: flex-end; min-height: 30px; }
    .bar { width: 12px; height: 25px; background: #4b5563; border-radius: 3px; }
  </style>
</head>
<body>

  <div class="nav">
    <button id="navMul" class="active">곱셈</button>
    <button id="navExp">지수</button>
    <button id="toggleSidebar">공식 보기</button>
  </div>

  <div class="main-container">
    <div class="formula-sidebar" id="sidebar">
      <div class="formula-group">
        <h3>Algebraic</h3>
        <div class="formula-item">(a+b)(a-b) <br>= a²-b²</div>
        <div class="formula-item">(a±b)² <br>= a²±2ab+b²</div>
        <div class="formula-item">(x+a)(x+b) <br>= x²+(a+b)x+ab</div>
      </div>
      <div class="formula-group">
        <h3>Power & Log</h3>
        <div class="formula-item">aᵐ · aⁿ <br>= aᵐ⁺ⁿ</div>
        <div class="formula-item">(aᵐ)ⁿ <br>= aᵐⁿ</div>
      </div>
    </div>

    <div class="content">
      <div id="mulCard" class="card">
        <h2>곱셈 암산</h2>
        <div class="row">
          <label>L <input type="number" id="digitsA" value="2" /></label>
          <label>R <input type="number" id="digitsB" value="2" /></label>
          <button id="mulNew">New</button>
        </div>
        <div class="problem" id="mulProblem">Start!</div>
        <div class="timer" id="mulTimer" style="text-align:center; color:#9ca3af;">0.00s</div>
        <div class="answer-row">
          <input type="text" id="mulAns" placeholder="?" />
        </div>
        <div class="result" id="mulResult"></div>
      </div>

      <div id="expCard" class="card" style="display:none;">
        <h2>지수 암산</h2>
        <div class="row">
          <select id="expBase" style="padding:8px; border-radius:8px; background:#161b22; color:white;"><option value="2">2ⁿ</option><option value="3">3ⁿ</option></select>
          <label>min <input type="number" id="expNMin" value="1" /></label>
          <label>max <input type="number" id="expNMax" value="10" /></label>
          <button id="expNew">New</button>
        </div>
        <div class="problem" id="expProblem">Start!</div>
        <div class="timer" id="expTimer" style="text-align:center; color:#9ca3af;">0.00s</div>
        <div class="answer-row">
          <input type="text" id="expAns" placeholder="?" />
        </div>
        <div class="result" id="expResult"></div>
      </div>

      <div class="history" id="history"></div>
      <div class="graph"><div class="graph-bars" id="graphBars"></div></div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleSidebar");
    const historyBox = document.getElementById("history");
    const graphBars = document.getElementById("graphBars");

    let mode = "mul", timer = null, start = 0, current = null, recent = [];

    // ★ 로컬 스토리지에서 기존 기록 불러오기
    window.onload = () => {
      const saved = localStorage.getItem('mentalLabHistory');
      if (saved) {
        recent = JSON.parse(saved);
        recent.forEach(item => renderHistoryUI(item.text, item.ok));
        updateGraph();
      }
    };

    function renderHistoryUI(text, ok) {
      const div = document.createElement("div");
      div.className = ok ? "correct" : "wrong";
      div.style.color = ok ? "#10b981" : "#ef4444";
      div.textContent = text;
      historyBox.appendChild(div);
      historyBox.scrollTop = historyBox.scrollHeight;
    }

    function saveAndRender(text, ok) {
      renderHistoryUI(text, ok);
      recent.push({ text, ok });
      if (recent.length > 30) recent.shift();
      // ★ 로컬 스토리지에 즉시 저장 (기기별 개인 저장)
      localStorage.setItem('mentalLabHistory', JSON.stringify(recent));
      updateGraph();
    }

    toggleBtn.onclick = (e) => { e.stopPropagation(); sidebar.classList.toggle("open"); };
    document.onclick = (e) => { if (!sidebar.contains(e.target)) sidebar.classList.remove("open"); };

    function startTimer(el) { start = performance.now(); if (timer) clearInterval(timer); timer = setInterval(() => { el.textContent = ((performance.now() - start) / 1000).toFixed(2) + "s"; }, 60); }
    function stopTimer() { if (timer) clearInterval(timer); timer = null; }
    function randNDigits(d) { d = Math.max(1, d); const min = Math.pow(10, d - 1), max = Math.pow(10, d) - 1; return Math.floor(Math.random() * (max - min + 1)) + min; }
    function updateGraph() { graphBars.innerHTML = ""; recent.forEach(item => { const bar = document.createElement("div"); bar.className = "bar " + (item.ok ? "correct" : "wrong"); bar.style.background = item.ok ? "#10b981" : "#ef4444"; graphBars.appendChild(bar); }); }
    function triggerNewProblem() { if (mode === "mul") mulNew.click(); else expNew.click(); }

    navMul.onclick = () => { mode = "mul"; navMul.classList.add("active"); navExp.classList.remove("active"); document.getElementById("mulCard").style.display = ""; document.getElementById("expCard").style.display = "none"; };
    navExp.onclick = () => { mode = "exp"; navExp.classList.add("active"); navMul.classList.remove("active"); document.getElementById("mulCard").style.display = "none"; document.getElementById("expCard").style.display = ""; };

    const mulNew = document.getElementById("mulNew"), mulProblem = document.getElementById("mulProblem"), mulAns = document.getElementById("mulAns"), mulResult = document.getElementById("mulResult"), mulTimer = document.getElementById("mulTimer");
    mulNew.onclick = () => { current = { type: "mul", a: randNDigits(parseInt(document.getElementById("digitsA").value)), b: randNDigits(parseInt(document.getElementById("digitsB").value)) }; mulProblem.textContent = `${current.a} × ${current.b}`; mulResult.textContent = ""; mulAns.value = ""; stopTimer(); startTimer(mulTimer); mulAns.focus(); };

    const expNew = document.getElementById("expNew"), expProblem = document.getElementById("expProblem"), expAns = document.getElementById("expAns"), expResult = document.getElementById("expResult"), expTimer = document.getElementById("expTimer");
    expNew.onclick = () => { const n = Math.floor(Math.random() * (parseInt(document.getElementById("expNMax").value) - parseInt(document.getElementById("expNMin").value) + 1)) + parseInt(document.getElementById("expNMin").value); current = { type: "exp", base: parseInt(document.getElementById("expBase").value), n }; expProblem.textContent = `${current.base}^${n}`; expResult.textContent = ""; expAns.value = ""; stopTimer(); startTimer(expTimer); expAns.focus(); };

    function checkAnswer() {
      if (!current) return;
      stopTimer();
      let ans, correct, text;
      if (current.type === "mul") {
        ans = Number(mulAns.value.replace(/,/g, ""));
        correct = current.a * current.b;
        text = `${current.a}×${current.b}=${ans}`;
      } else {
        ans = Number(expAns.value.replace(/,/g, ""));
        correct = Math.pow(current.base, current.n);
        text = `${current.base}^${current.n}=${ans}`;
      }
      const ok = ans === correct;
      const resEl = current.type === "mul" ? mulResult : expResult;
      resEl.textContent = `정답: ${correct.toLocaleString()} ${ok ? '· OK' : '· WRONG'}`;
      resEl.className = "result " + (ok ? "correct" : "wrong");
      saveAndRender(text, ok);
    }

    mulAns.onkeydown = (e) => { if (e.key === "Enter") checkAnswer(); };
    expAns.onkeydown = (e) => { if (e.key === "Enter") checkAnswer(); };
    mulAns.oninput = () => { if (mulAns.value.endsWith(" ")) { mulAns.value = mulAns.value.trim(); triggerNewProblem(); } };
    expAns.oninput = () => { if (expAns.value.endsWith(" ")) { expAns.value = expAns.value.trim(); triggerNewProblem(); } };
    document.onkeydown = (e) => { if ((e.code === "Space" || e.key === " ") && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); triggerNewProblem(); } };
  </script>
</body>
</html>
