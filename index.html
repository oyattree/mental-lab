<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mental Lab v1.3</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #161b22; color: #e5e7eb; display: flex; flex-direction: column; height: 100vh; font-size: 1.2rem; overflow: hidden; }
    
    /* Navigation */
    .nav { display: flex; gap: 10px; padding: 15px; background: #0f141a; border-bottom: 1px solid #2f3540; flex: 0 0 auto; align-items: center; overflow-x: auto; }
    .nav button { padding: 8px 16px; border-radius: 8px; border: 1px solid #2f3540; background: #1f252f; color: #e5e7eb; cursor: pointer; font-size: 0.95rem; font-weight: 600; white-space: nowrap; transition: 0.2s; }
    .nav button.active { background: #e5e7eb; color: #0f141a; }
    #toggleSidebar { background: #238636; border: none; color: white; margin-left: auto; }

    .main-container { display: flex; flex: 1; position: relative; overflow: hidden; width: 100%; }

    /* Sidebar */
    .formula-sidebar { width: 320px; background: #0d1117; border-right: 1px solid #2f3540; padding: 20px; overflow-y: auto; transition: transform 0.3s ease; z-index: 100; flex-shrink: 0; }
    @media (max-width: 768px) { .formula-sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); } .formula-sidebar.open { transform: translateX(0); } }
    .formula-group h3 { color: #8b949e; border-bottom: 1px solid #30363d; padding-bottom: 5px; margin-top: 20px; font-size: 1rem; }
    .formula-item { background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-family: monospace; color: #58a6ff; border: 1px solid #30363d; font-size: 0.95rem; line-height: 1.4; }

    /* Content Area */
    .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; width: 100%; }
    .card { width: 100%; max-width: 550px; background: #1f252f; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); margin-bottom: 20px; position: relative; }
    .card h2 { margin: 0 0 15px; font-size: 1.4rem; text-align: center; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
    
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: flex-end; justify-content: center; }
    .row label { font-size: 0.8rem; display: flex; flex-direction: column; gap: 3px; color: #9ca3af; }
    .row input, .row select { padding: 8px; border-radius: 6px; border: 1px solid #2f3540; background: #161b22; color: #e5e7eb; font-size: 0.9rem; text-align: center; }
    
    .problem { font-size: 3.5rem; font-weight: 800; text-align: center; margin: 20px 0 5px; min-height: 1.2em; color: #ffffff; }
    .problem-sub { font-size: 0.95rem; color: #8b949e; text-align: center; margin-bottom: 15px; }
    .timer { font-size: 1.1rem; text-align: center; color: #6b7280; margin-bottom: 15px; font-family: monospace; }
    
    .answer-row { display: flex; justify-content: center; width: 100%; margin-bottom: 10px; }
    .answer-row input { width: 100%; max-width: 350px; padding: 12px; border-radius: 12px; border: 2px solid #30363d; background: #0d1117; color: #e5e7eb; font-size: 2.2rem; text-align: center; outline: none; transition: 0.2s; }
    .answer-row input:focus { border-color: #58a6ff; }

    .result { text-align: center; min-height: 1.6em; font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
    .result.correct { color: #10b981; }
    .result.wrong { color: #ef4444; }

    /* Shortcuts Helper */
    .shortcuts { display: flex; justify-content: center; gap: 15px; margin-top: 15px; font-size: 0.75rem; color: #4b5563; border-top: 1px solid #2f3540; padding-top: 10px; }
    .shortcuts kbd { background: #30363d; padding: 2px 5px; border-radius: 4px; color: #e5e7eb; font-family: monospace; }

    /* History & Graph */
    .history { width: 100%; max-width: 550px; background: #1f252f; border-radius: 15px 15px 0 0; padding: 15px; border-top: 1px solid #2f3540; height: 160px; overflow-y: auto; font-size: 0.95rem; }
    .graph { width: 100%; max-width: 550px; padding: 12px; background: #1f252f; border-radius: 0 0 15px 15px; border-top: 1px solid #2f3540; margin-bottom: 40px; }
    .graph-bars { display: flex; gap: 4px; align-items: flex-end; min-height: 30px; justify-content: center; }
    .bar { width: 10px; height: 25px; background: #4b5563; border-radius: 2px; }
  </style>
</head>
<body>

  <div class="nav">
    <button id="navMul" class="active">Multiplication</button>
    <button id="navExp">Exponential</button>
    <button id="navGeo">Geometry</button>
    <button id="toggleSidebar">View Formulas</button>
  </div>

  <div class="main-container">
    <div class="formula-sidebar" id="sidebar">
      <div class="formula-group">
        <h3>Algebraic</h3>
        <div class="formula-item">a(b±1) = ab ± a</div>
        <div class="formula-item">(a+b)(a-b) = a²-b²</div>
      </div>
      <div class="formula-group">
        <h3>Power & Log</h3>
        <div class="formula-item">log₂2 ≈ 0.3, log₂3 ≈ 0.48</div>
        <div class="formula-item">2¹⁰ = 1024 (1k)</div>
      </div>
      <div class="formula-group">
        <h3>Pythagorean (a, b, c)</h3>
        <div class="formula-item"><b>If a is Odd:</b><br>b = (a²-1)/2, c = b + 1</div>
        <div class="formula-item"><b>If a is Even:</b><br>b = (a/2)² - 1, c = b + 2</div>
      </div>
    </div>

    <div class="content">
      <div id="mulCard" class="card">
        <h2>Multiplication</h2>
        <div class="row">
          <label>Digits L <input type="number" id="digitsA" value="2" /></label>
          <label>Digits R <input type="number" id="digitsB" value="2" /></label>
          <button id="mulNew" style="padding:8px 15px; border-radius:6px; cursor:pointer; background:#238636; color:white; border:none; font-weight:bold;">NEW</button>
        </div>
        <div class="problem" id="mulProblem">READY</div>
        <div class="timer" id="mulTimer">0.00s</div>
        <div class="answer-row"><input type="text" id="mulAns" placeholder="?" autocomplete="off" /></div>
        <div class="result" id="mulResult"></div>
        <div class="shortcuts">
          <span><kbd>Enter</kbd> Check</span>
          <span><kbd>Space ×2</kbd> Next Problem</span>
        </div>
      </div>

      <div id="expCard" class="card" style="display:none;">
        <h2>Exponential</h2>
        <div class="row">
          <select id="expBase" style="padding:8px;">
            <option value="2">2ⁿ</option>
            <option value="3">3ⁿ</option>
          </select>
          <label>min <input type="number" id="expNMin" value="1" /></label>
          <label>max <input type="number" id="expNMax" value="10" /></label>
          <button id="expNew" style="padding:8px 15px; border-radius:6px; cursor:pointer; background:#238636; color:white; border:none; font-weight:bold;">NEW</button>
        </div>
        <div class="problem" id="expProblem">READY</div>
        <div class="timer" id="expTimer">0.00s</div>
        <div class="answer-row"><input type="text" id="expAns" placeholder="?" autocomplete="off" /></div>
        <div class="result" id="expResult"></div>
        <div class="shortcuts">
          <span><kbd>Enter</kbd> Check</span>
          <span><kbd>Space ×2</kbd> Next Problem</span>
        </div>
      </div>

      <div id="geoCard" class="card" style="display:none;">
        <h2>Pythagorean</h2>
        <div class="row">
          <select id="geoMode" style="padding:8px;">
            <option value="odd">Odd Pattern</option>
            <option value="even">Even Pattern</option>
            <option value="mix">Mix All</option>
          </select>
          <label>a Min <input type="number" id="geoMin" value="3" /></label>
          <label>a Max <input type="number" id="geoMax" value="20" /></label>
          <button id="geoNew" style="padding:8px 15px; border-radius:6px; cursor:pointer; background:#238636; color:white; border:none; font-weight:bold;">NEW</button>
        </div>
        <div class="problem" id="geoProblem">READY</div>
        <p class="problem-sub">Find b, c when shortest side is a (e.g., 24, 25)</p>
        <div class="timer" id="geoTimer">0.00s</div>
        <div class="answer-row"><input type="text" id="geoAns" placeholder="b, c" autocomplete="off" /></div>
        <div class="result" id="geoResult"></div>
        <div class="shortcuts">
          <span><kbd>Enter</kbd> Check</span>
          <span><kbd>Space ×2</kbd> Next Problem</span>
        </div>
      </div>

      <div class="history" id="history"></div>
      <div class="graph"><div class="graph-bars" id="graphBars"></div></div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleSidebar");
    const historyBox = document.getElementById("history");
    const graphBars = document.getElementById("graphBars");
    
    let mode = "mul";
    let timer = null;
    let start = 0;
    let current = null;
    let recent = [];

    window.onload = () => {
      const saved = localStorage.getItem('mentalLabHistory');
      if (saved) {
        recent = JSON.parse(saved);
        recent.forEach(item => renderHistoryUI(item.text, item.ok));
        updateGraph();
      }
    };

    function renderHistoryUI(text, ok) {
      const div = document.createElement("div");
      div.style.color = ok ? "#10b981" : "#ef4444";
      div.textContent = text;
      historyBox.appendChild(div);
      historyBox.scrollTop = historyBox.scrollHeight;
    }

    function saveAndRender(text, ok) {
      renderHistoryUI(text, ok);
      recent.push({ text, ok });
      if (recent.length > 30) recent.shift();
      localStorage.setItem('mentalLabHistory', JSON.stringify(recent));
      updateGraph();
    }

    function updateGraph() {
      graphBars.innerHTML = "";
      recent.forEach(item => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.background = item.ok ? "#10b981" : "#ef4444";
        graphBars.appendChild(bar);
      });
    }

    toggleBtn.onclick = (e) => { e.stopPropagation(); sidebar.classList.toggle("open"); };
    document.onclick = (e) => { if (!sidebar.contains(e.target)) sidebar.classList.remove("open"); };

    function startTimer(el) {
      start = performance.now();
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        el.textContent = ((performance.now() - start) / 1000).toFixed(2) + "s";
      }, 60);
    }
    function stopTimer() { if (timer) clearInterval(timer); timer = null; }

    const navs = { mul: document.getElementById("navMul"), exp: document.getElementById("navExp"), geo: document.getElementById("navGeo") };
    const cards = { mul: document.getElementById("mulCard"), exp: document.getElementById("expCard"), geo: document.getElementById("geoCard") };

    Object.keys(navs).forEach(k => {
      navs[k].onclick = () => {
        mode = k;
        Object.keys(navs).forEach(x => navs[x].classList.toggle("active", x === k));
        Object.keys(cards).forEach(x => cards[x].style.display = (x === k ? "" : "none"));
        document.getElementById(k + "Ans").focus();
      };
    });

    function triggerNewProblem() {
      document.getElementById(mode + "New").click();
    }

    document.getElementById("mulNew").onclick = () => {
      const da = parseInt(document.getElementById("digitsA").value) || 2;
      const db = parseInt(document.getElementById("digitsB").value) || 2;
      current = { type: "mul", a: randNDigits(da), b: randNDigits(db) };
      document.getElementById("mulProblem").textContent = `${current.a} × ${current.b}`;
      resetProblem("mul");
    };

    document.getElementById("expNew").onclick = () => {
      const min = parseInt(document.getElementById("expNMin").value) || 1;
      const max = parseInt(document.getElementById("expNMax").value) || 10;
      const n = Math.floor(Math.random() * (max - min + 1)) + min;
      const base = parseInt(document.getElementById("expBase").value);
      current = { type: "exp", base, n };
      document.getElementById("expProblem").textContent = `${base}^${n}`;
      resetProblem("exp");
    };

    document.getElementById("geoNew").onclick = () => {
      const min = parseInt(document.getElementById("geoMin").value) || 3;
      const max = parseInt(document.getElementById("geoMax").value) || 20;
      const gMode = document.getElementById("geoMode").value;
      let a;
      if (gMode === "odd") a = randOdd(min, max);
      else if (gMode === "even") a = randEven(min, max);
      else a = Math.floor(Math.random() * (max - min + 1)) + min;
      let b, c;
      if (a % 2 !== 0) { b = (Math.pow(a, 2) - 1) / 2; c = b + 1; }
      else { b = Math.pow(a / 2, 2) - 1; c = b + 2; }
      current = { type: "geo", a, b, c };
      document.getElementById("geoProblem").textContent = `a = ${a}`;
      resetProblem("geo");
    };

    function resetProblem(prefix) {
      document.getElementById(prefix + "Result").textContent = "";
      document.getElementById(prefix + "Ans").value = "";
      stopTimer();
      startTimer(document.getElementById(prefix + "Timer"));
      document.getElementById(prefix + "Ans").focus();
    }

    function randNDigits(d) {
      const min = Math.pow(10, d - 1), max = Math.pow(10, d) - 1;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function randOdd(min, max) {
      let n = Math.floor(Math.random() * (max - min + 1)) + min;
      return n % 2 !== 0 ? n : (n + 1 > max ? n - 1 : n + 1);
    }
    function randEven(min, max) {
      let n = Math.floor(Math.random() * (max - min + 1)) + min;
      return n % 2 === 0 ? n : (n + 1 > max ? n - 1 : n + 1);
    }

    function checkAnswer() {
      if (!current) return;
      stopTimer();
      const input = document.getElementById(mode + "Ans");
      const val = input.value.trim().replace(/ /g, "");
      let ok = false, correctStr = "", logText = "";

      if (current.type === "mul") {
        const ans = Number(val.replace(/,/g, ""));
        const correct = current.a * current.b;
        ok = (ans === correct);
        correctStr = correct.toLocaleString();
        logText = `[Mul] ${current.a}×${current.b}=${ans}`;
      } 
      else if (current.type === "exp") {
        const ans = Number(val.replace(/,/g, ""));
        const correct = Math.pow(current.base, current.n);
        ok = (ans === correct);
        correctStr = correct.toLocaleString();
        logText = `[Exp] ${current.base}^${current.n}=${ans}`;
      } 
      else if (current.type === "geo") {
        const parts = val.split(",").map(Number);
        ok = (parts[0] === current.b && parts[1] === current.c);
        correctStr = `${current.b}, ${current.c}`;
        logText = `[Geo] a=${current.a} -> ${val}`;
      }

      const resEl = document.getElementById(mode + "Result");
      resEl.textContent = `Correct: ${correctStr} ${ok ? '· OK' : '· WRONG'}`;
      resEl.className = "result " + (ok ? "correct" : "wrong");
      saveAndRender(logText, ok);
    }

    ["mul", "exp", "geo"].forEach(p => {
      document.getElementById(p + "Ans").onkeydown = (e) => { if (e.key === "Enter") checkAnswer(); };
      document.getElementById(p + "Ans").oninput = (e) => {
        if (e.target.value.endsWith("  ")) { 
          e.target.value = e.target.value.trim();
          triggerNewProblem();
        }
      };
    });

    document.onkeydown = (e) => {
      if ((e.code === "Space") && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        triggerNewProblem();
      }
    };
  </script>
</body>
</html>
